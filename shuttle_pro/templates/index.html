{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UrbanXpress - Smart Shuttle System</title>
  <link rel="stylesheet" href="{% static 'css/index.css' %}">
</head>
<body>

<!-- Toast Messages -->
<div id="toast-container">
  {% for message in messages %}
    <div class="toast {{ message.tags }}">{{ message }}</div>
  {% endfor %}
</div>

<!-- Navbar -->
<nav class="navbar">
  <div class="logo">Urban<span>Xpress</span></div>
  <ul class="nav-links">
    <li><a href="{% url 'home' %}" class="active">Home</a></li>
    <li><a href="{% url 'booking' %}">Booking</a></li>
    <li><a href="{% url 'track2' %}">Tracking</a></li>
    <li><a href="{% url 'operator' %}">Operator</a></li>
    {% if user.is_authenticated and user.is_superuser %}
    <li><a href="{% url 'admin_dashboard' %}">Admin</a></li>
    {% endif %}
  </ul>
  <div class="hamburger">&#9776;</div>
</nav>

<!-- Hero Section -->
<section class="hero">
  <div class="content" id="content">
    {% if not user.is_authenticated %}
      <button id="loginBtn" class="popup-btn">Login / Sign Up</button>
    {% endif %}

    <!-- Popup Overlay -->
    <div class="overlay" id="overlay">
      <div class="auth-box" onclick="event.stopPropagation()">
        <div class="tab-buttons">
          <button id="loginTab" class="active" onclick="showLogin()">Login</button>
          <button id="signupTab" onclick="showSignup()">Sign Up</button>
        </div>

        <div class="error-msg" id="errorMsg"></div>

        <div class="form-container" id="loginForm">
          <h2>Welcome Back</h2>
          <input type="text" placeholder="Username" id="loginUsername"/>
          <input type="password" placeholder="Password" id="loginPassword"/>
          <button type="button" id="loginSubmit">Login</button>
        </div>

        <div class="form-container" id="signupForm" style="display: none;">
          <h2>Create Account</h2>
          <input type="text" placeholder="Username" id="signupUsername"/>
          <input type="email" placeholder="Email" id="signupEmail"/>
          <input type="password" placeholder="Password" id="signupPassword"/>
          <button type="button" id="signupSubmit">Sign Up</button>
        </div>
      </div>
    </div>
  </div>

  <h1>Smart, Reliable, and Urban Mobility</h1>
  <p>UrbanXpress helps people travel smarter with fast, affordable, and eco-friendly shuttles.</p>
  <a href="{% url 'booking' %}" class="cta-btn" id="bookBtn">Book Your Ride</a>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("overlay");
  const loginBtn = document.getElementById("loginBtn");
  const bookBtn = document.getElementById("bookBtn");
  const loginFormDiv = document.getElementById("loginForm");
  const signupFormDiv = document.getElementById("signupForm");
  const errorMsg = document.getElementById("errorMsg");

  function showLogin() {
    loginFormDiv.style.display = "block";
    signupFormDiv.style.display = "none";
    document.getElementById("loginTab").classList.add("active");
    document.getElementById("signupTab").classList.remove("active");
    if(errorMsg) errorMsg.style.display="none";
  }

  function showSignup() {
    loginFormDiv.style.display = "none";
    signupFormDiv.style.display = "block";
    document.getElementById("signupTab").classList.add("active");
    document.getElementById("loginTab").classList.remove("active");
    if(errorMsg) errorMsg.style.display="none";
  }

  if(loginBtn){
    loginBtn.addEventListener("click", () => { overlay.style.display="flex"; showLogin(); });
  }

  if(bookBtn){
    bookBtn.addEventListener("click", e => {
      {% if not user.is_authenticated %}
        e.preventDefault();
        overlay.style.display="flex";
        showLogin();
      {% endif %}
    });
  }

  overlay.addEventListener("click",(e)=>{ if(e.target.id==="overlay"){ overlay.style.display="none"; } });

  const loginSubmit = document.getElementById("loginSubmit");
  if(loginSubmit){
    loginSubmit.addEventListener("click", ()=>{
      const username=document.getElementById("loginUsername").value;
      const password=document.getElementById("loginPassword").value;
      fetch("{% url 'login' %}",{
        method:"POST",
        headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
        body:JSON.stringify({username,password})
      }).then(res=>res.json()).then(data=>{
        if(data.success){
          overlay.style.display="none";
          location.href="{% url 'booking' %}";
        } else {
          errorMsg.innerText=data.message;
          errorMsg.style.display="block";
        }
      });
    });
  }

  const signupSubmit = document.getElementById("signupSubmit");
  if(signupSubmit){
    signupSubmit.addEventListener("click", ()=>{
      const username=document.getElementById("signupUsername").value;
      const email=document.getElementById("signupEmail").value;
      const password=document.getElementById("signupPassword").value;
      fetch("{% url 'signup' %}",{
        method:"POST",
        headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
        body:JSON.stringify({username,email,password})
      }).then(res=>res.json()).then(data=>{
        if(data.success){
          overlay.style.display="none";
          location.href="{% url 'booking' %}";
        } else {
          errorMsg.innerText=data.message;
          errorMsg.style.display="block";
        }
      });
    });
  }

  {% if user.is_authenticated %}
    const btn = document.createElement("button");
    btn.className = "popup-btn";
    btn.innerText = "Logout";
    btn.onclick = () => { window.location.href="{% url 'logout' %}"; };
    if(document.getElementById("content")){
      document.getElementById("content").prepend(btn);
    }
  {% endif %}

  window.showLogin=showLogin;
  window.showSignup=showSignup;
});
  </script>
</body>
</html>
